---
title: blue-green ë¬´ì¤‘ë‹¨ ë°°í¬ with Docker, nginx
description: Dockerì™€ í•¨ê»˜ blue-green ë°©ì‹ìœ¼ë¡œ ë¬´ì¤‘ë‹¨ ë°°í¬í•˜ê¸°
thumbnail: /thumbnails/bluegreen-ori.gif
date: "Jan 11, 2026"
---

## Nginxì— Dockerë¥¼ ì´ìš©í•˜ì—¬ blue-green ë¬´ì¤‘ë‹¨ ë°°í¬í•˜ê¸°

<br />

ì–´ì§¸ ë°°í¬ ê´€ë ¨ ê¸€ë§Œ ì ê²Œ ëœë‹¤. ã… ã… ë‚œ ì¢‹ì•„ ~~ íšŒì‚¬ê°€ ì°©ì‹¤íˆ ì„±ì¥í•˜ê³  ìˆì–´ ìš”ìƒˆëŠ” ê¸°ì¡´ì— ìˆë˜ ë ˆê±°ì‹œ ì‚¬ì´íŠ¸ë“¤ì„ ë¦¬ë‰´ì–¼í•˜ê³  ìˆë‹¤. ê²Œë‹¤ê°€ ë°”ì´ë¸Œ ì½”ë”©ë„ ì ê·¹ì ìœ¼ë¡œ ìˆ˜ìš©í•´ ì‚¬ìš©í•˜ë‹¤ ë³´ë‹ˆ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ì§¤ ì¼ì´ ê±°ì˜ ì—†ë‹¤. ìì—°ìŠ¤ëŸ½ê²Œ ìë™í™”ë‚˜ ë°°í¬ ê°™ì€ ê²ƒì—ë„ ì†ì„ ë»—ê²Œ ë˜ì—ˆë‹¤. 

<br />
ì´ë²ˆì— ìƒˆë¡­ê²Œ ë¦¬ë‰´ì–¼í•œ í˜ì´ì§€ëŠ” ì„œë²„ì— docker ì´ë¯¸ì§€ë¥¼ ë„ì›Œ ë¹Œë“œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°°í¬í•˜ì˜€ë‹¤. ê¸°ì¡´ì—ëŠ” ëª¨ë‘ pm2ì™€ nginxë¡œ ì •ì  íŒŒì¼ì„ ì„œë¹™í•´ ë°°í¬í–ˆì—ˆë‹¤. ì´ ë°©ì‹ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  dockerë¥¼ ë„ì…í•œ ì´ìœ ëŠ” 

<br />
<ol>
  <li>1. í”„ë¡œì íŠ¸ì— Next.jsì˜ API Routes ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ”ë°, ì´ ê¸°ëŠ¥ì€ ì„œë²„ ëŸ°íƒ€ì„ì´ í•„ìš”í•˜ë‹¤.
  next.configì˜ output: standalone ëª¨ë“œë¡œ ì„¤ì •í•˜ì—¬ ë…ë¦½ ì‹¤í–‰ ê°€ëŠ¥í•œ ì„œë²„ë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤. ê·¸ëŸ°ë° ì„œë²„ ë‚´ ë…¸ë“œ ë²„ì „ê³¼ ì´ í”„ë¡œì íŠ¸ê°€ í•„ìš”ë¡œ í•˜ëŠ” ë…¸ë“œ ë²„ì „ì´ ë‹¬ë¼ í™˜ê²½ì„ ë§ì¶œ í•„ìš”ê°€ ìˆì—ˆë‹¤.</li>
  <li>2. ì¶”í›„ì— ìˆì„ CICD ì—°ë™ì„ í¸í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„œ</li>
</ol>

<br />

ê·¸ë˜ì„œ ë¨¼ì € dockerë¡œ ë¹Œë“œí•˜ì—¬ ë°°í¬í•´ë‘ì—ˆëŠ”ë° ì™¸ë¶€ ë…¸ì¶œ ì „ê¹Œì§€ëŠ” ìš°ë¦¬ë¼ë¦¬ ë³´ëŠ” ì‚¬ì´íŠ¸ë¼ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì•˜ë‹¤ ë³´ë‹ˆ ë„ì»¤ê°€ ë¹Œë“œë˜ëŠ” ì¤‘ê°„ì— ì‚¬ì´íŠ¸ì— ë“¤ì–´ê°€ë©´ 502 bad gatewayê°€ ë–´ë‹¤. ğŸ˜… ì´ì œ ê³§ ì™¸ë¶€ì— ë…¸ì¶œì‹œí‚¬ ì˜ˆì •ì´ë¯€ë¡œ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ë„ì…í•˜ì˜€ë‹¤. 

<br />
<div className="bar" />

## Blue - Green ë¬´ì¤‘ë‹¨ ë°°í¬
ê°œë…ì€ ì—„ì²­ ê°„ë‹¨í•˜ë‹¤. 

<MDXImage
  src="/posts/blue-green/diagram.png"
  alt="blue-green diagram"
  style={{ width: "70%" }}
/>

blueì™€ greenì´ ë²ˆê°ˆì•„ê°€ë©° updateì™€ active ì—­í• ì„ ë§¡ëŠ” ê²ƒì´ë‹¤. 
<br />
ì‚¬ì´íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œ greenì´ ë°°í¬ë¼ ìˆìœ¼ë©´ blueê°€ ë¹Œë“œë¥¼ í•˜ê³  ë¹Œë“œê°€ ëë‚˜ë©´ ë°°í¬ í˜ì´ì§€ë¥¼ blueë¡œ ë°”ê¾¸ê³  greenì€ ëŒ€ê¸° ìƒíƒœê°€ ëœë‹¤. ì„œë¡œ ì—­í• ì„ ìŠ¤ìœ„ì¹˜í•˜ë©° ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šê²Œ í•˜ëŠ” ë°©ì‹ì´ë‹¤. 
<br />
ì„œë²„ ë‚´ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë°°í¬ê°€ ì´ë£¨ì–´ì§„ë‹¤.

<CodeBlock>
```
1. git pull ë°›ê¸°
2. deploy.sh ì‹¤í–‰
3. ëŒ€ê¸° ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë¹Œë“œ (ì˜ˆ: Green)
4. í—¬ìŠ¤ì²´í¬ í†µê³¼
5. Nginx ì„¤ì • ë³€ê²½ (Blue â†’ Green)
6. Nginx reload
7. ì´ì „ ì»¨í…Œì´ë„ˆ(Blue) ëŒ€ê¸° ìƒíƒœë¡œ ì „í™˜

```
</CodeBlock>

blueì™€ green ì»¨í…Œì´ë„ˆ ë‘ ê°œê°€ í•„ìš”í•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 2ë°°ë‹¤. ì†Œê·œëª¨ ì„œë²„ì—ì„œëŠ” ë¶€ë‹´ì´ ë  ìˆ˜ ìˆë‹¤.
<br />

### docker-compose íŒŒì¼ ìƒì„±
docker-compose.blue.ymlì™€ docker-compose.green.ymlìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë§Œë“¤ì–´ ì£¼ì—ˆë‹¤. <br />
ê¸°ì¡´ì— 3080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆìœ¼ë¯€ë¡œ 3080, 3081 í¬íŠ¸ë¥¼ ë¶€ì—¬í•˜ì˜€ë‹¤. greenë„ blueì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ìƒì„±í•˜ì˜€ë‹¤.

<CodeBlock>
```

// docker-compose.blue.yml

services:
  barista-blue:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_BASE_URL=https://api.example.com // ì‹¤ì œ í™˜ê²½ ë³€ìˆ˜ëŠ” env íŒŒì¼ë¡œ ê´€ë¦¬
        - NEXT_PUBLIC_MONITOR_API_URL=https://example.com
        - NEXT_PUBLIC_MEGA_API_URL=https://api.example.com
        - NEXT_PUBLIC_BARISTA_MONITOR_URL=https://example.com
    container_name: barista-blue
    restart: unless-stopped
    ports:
      - "3080:3000"
    environment:
      - NODE_ENV=production
    networks:
      - ~-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  ~-network:
    driver: bridge

```
</CodeBlock>

### Dockerfile íŒŒì¼ ìˆ˜ì •

<CodeBlock>
```
# Stage 1: Dependencies
FROM node:20-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install bun for faster package installation
RUN npm install -g bun

# Copy package files
COPY package.json bun.lock* ./

# Install dependencies
RUN bun install --frozen-lockfile

# ================================
# Stage 2: Builder
# ================================
FROM node:20-alpine AS builder
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Build arguments for environment variables
ARG NEXT_PUBLIC_API_BASE_URL
ARG NEXT_PUBLIC_MONITOR_API_URL
ARG NEXT_PUBLIC_MEGA_API_URL
ARG NEXT_PUBLIC_BARISTA_MONITOR_URL

# Set environment variables for build
ENV NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL
ENV NEXT_PUBLIC_MONITOR_API_URL=$NEXT_PUBLIC_MONITOR_API_URL
ENV NEXT_PUBLIC_MEGA_API_URL=$NEXT_PUBLIC_MEGA_API_URL
ENV NEXT_PUBLIC_BARISTA_MONITOR_URL=$NEXT_PUBLIC_BARISTA_MONITOR_URL

# Build the application
RUN npm run build

# ================================
# Stage 3: Runner (Production)
# ================================
FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# Create non-root user for security
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy necessary files from builder
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# Set correct permissions
RUN chown -R nextjs:nodejs /app

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
```
</CodeBlock>

ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí–ˆë‹¤ í•˜ë”ë¼ë„ ì–´ë–»ê²Œ nginxì—ì„œ ë‘ ì»¨í…Œì´ë„ˆë¥¼ ë°”ê¿”ì¹˜ê¸° í• ê¹Œ? <br />
ìŠ¤ìœ„ì¹˜ë¥¼ í•´ì¤„ ì‹¤í–‰ íŒŒì¼ì´ í•„ìš”í•˜ë‹¤.

### deploy.sh ì‹¤í–‰ íŒŒì¼ ìƒì„±

<CodeBlock>
```
// deploy.sh

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

# ================================
# ì„¤ì •
# ================================
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
NGINX_BIN="~/nginx" // ì„œë²„ ë‚´ nginx í´ë” ê²½ë¡œ
NGINX_CONF="~/nginx.conf" // ì„œë²„ ë‚´ ngnix.conf íŒŒì¼ ê²½ë¡œ
HEALTH_CHECK_URL_BLUE="http://localhost:3080"
HEALTH_CHECK_URL_GREEN="http://localhost:3081"
HEALTH_CHECK_RETRIES=30
HEALTH_CHECK_INTERVAL=2

# ìƒ‰ìƒ ì¶œë ¥
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ================================
# í•¨ìˆ˜ ì •ì˜
# ================================

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸ (nginx ì„¤ì • ê¸°ë°˜)
get_active_env() {
    if grep -q "server localhost:3080;" "$NGINX_CONF" 2>/dev/null && \
       ! grep -q "#.*server localhost:3080;" "$NGINX_CONF" 2>/dev/null; then
        echo "blue"
    elif grep -q "server localhost:3081;" "$NGINX_CONF" 2>/dev/null && \
         ! grep -q "#.*server localhost:3081;" "$NGINX_CONF" 2>/dev/null; then
        echo "green"
    else
        echo "blue"  # ê¸°ë³¸ê°’
    fi
}

# í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
health_check() {
    local url=$1
    local retries=$HEALTH_CHECK_RETRIES

    log_info "í—¬ìŠ¤ì²´í¬ ì‹œì‘: $url"

    while [ $retries -gt 0 ]; do
        if curl -sf "$url" > /dev/null 2>&1; then
            log_success "í—¬ìŠ¤ì²´í¬ í†µê³¼!"
            return 0
        fi

        retries=$((retries - 1))
        log_info "í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ë‚¨ì€ ì‹œë„: $retries)"
        sleep $HEALTH_CHECK_INTERVAL
    done

    log_error "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
    return 1
}

# Nginx ì„¤ì • ì „í™˜
switch_nginx() {
    local target_env=$1

    log_info "Nginx íŠ¸ë˜í”½ì„ $target_env í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì¤‘..."

    if [ "$target_env" == "blue" ]; then
        # Blueë¡œ ì „í™˜: 3080 í™œì„±í™”, 3081 ì£¼ì„ì²˜ë¦¬
        sudo sed -i 's/#.*server localhost:3080;/server localhost:3080;/' "$NGINX_CONF"
        sudo sed -i 's/^\([^#]*\)server localhost:3081;/# server localhost:3081;/' "$NGINX_CONF"
    else
        # Greenìœ¼ë¡œ ì „í™˜: 3081 í™œì„±í™”, 3080 ì£¼ì„ì²˜ë¦¬
        sudo sed -i 's/#.*server localhost:3081;/server localhost:3081;/' "$NGINX_CONF"
        sudo sed -i 's/^\([^#]*\)server localhost:3080;/# server localhost:3080;/' "$NGINX_CONF"
    fi

    # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
    if sudo $NGINX_BIN -t; then
        sudo $NGINX_BIN -s reload
        log_success "Nginx íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
    else
        log_error "Nginx ì„¤ì • ì˜¤ë¥˜!"
        return 1
    fi
}

# ================================
# ë©”ì¸ ë°°í¬ ë¡œì§
# ================================

main() {
    log_info "=========================================="
    log_info "Blue-Green ë°°í¬ ì‹œì‘"
    log_info "=========================================="

    cd "$PROJECT_DIR"

    # í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
    CURRENT_ENV=$(get_active_env)

    if [ "$CURRENT_ENV" == "blue" ]; then
        TARGET_ENV="green"
        TARGET_COMPOSE="docker-compose.green.yml"
        TARGET_HEALTH_URL=$HEALTH_CHECK_URL_GREEN
        OLD_COMPOSE="docker-compose.blue.yml"
    else
        TARGET_ENV="blue"
        TARGET_COMPOSE="docker-compose.blue.yml"
        TARGET_HEALTH_URL=$HEALTH_CHECK_URL_BLUE
        OLD_COMPOSE="docker-compose.green.yml"
    fi

    log_info "í˜„ì¬ í™œì„± í™˜ê²½: $CURRENT_ENV"
    log_info "ë°°í¬ ëŒ€ìƒ í™˜ê²½: $TARGET_ENV"

    # 1. ìƒˆ í™˜ê²½ì— ë°°í¬
    log_info "[$TARGET_ENV] ìƒˆ ë²„ì „ ë¹Œë“œ ë° ë°°í¬ ì¤‘..."
    docker compose -f "$TARGET_COMPOSE" up -d --build

    # 2. í—¬ìŠ¤ì²´í¬
    log_info "[$TARGET_ENV] í—¬ìŠ¤ì²´í¬ ì§„í–‰ ì¤‘..."
    if ! health_check "$TARGET_HEALTH_URL"; then
        log_error "ë°°í¬ ì‹¤íŒ¨! $TARGET_ENV í™˜ê²½ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_warning "ë¡¤ë°±: $TARGET_ENV ì»¨í…Œì´ë„ˆ ì¤‘ì§€"
        docker compose -f "$TARGET_COMPOSE" down
        exit 1
    fi

    # 3. Nginx íŠ¸ë˜í”½ ì „í™˜
    switch_nginx "$TARGET_ENV"

    log_success "=========================================="
    log_success "ë°°í¬ ì™„ë£Œ!"
    log_success "í™œì„± í™˜ê²½: $TARGET_ENV"
    log_success "=========================================="

    # ìƒíƒœ ì¶œë ¥
    echo ""
    log_info "í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
    docker ps --filter "name=~-barista" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"
```
</CodeBlock>

ë‹¹ì—°íˆ ì„œë²„ ë‚´ nginx.conf íŒŒì¼ë„ ê³ ì³ì•¼ í•œë‹¤. <br />
ê¸°ì¡´ conf íŒŒì¼ ë¦¬ë‰´ì–¼ í˜ì´ì§€ ë¶€ë¶„ì— ì•„ë˜ í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤.

<CodeBlock>
```
upstream barista_backend { 
    // ğŸ‘† upstreamì€ nginxì—ì„œ ë¡œë“œë°¸ëŸ°ì‹±/í”„ë¡ì‹œ ëŒ€ìƒ ì„œë²„ë¥¼ ì •ì˜í•˜ëŠ” ë¸”ë¡ì´ë‹¤.
    # í˜„ì¬ í™œì„± í™˜ê²½ (blue ë˜ëŠ” green)
    server localhost:3080;  # blue (ê¸°ë³¸)
    # server localhost:3081;  # green
}
...
```
</CodeBlock>


ì„œë²„ì—ì„œ git pull ë°›ê³  (ì„œë²„ ë‚´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ íŒŒì¼ì— deploy.shê°€ ìˆì–´ì•¼ í•œë‹¤.) 

<CodeBlock>./deploy.sh</CodeBlock>

ì‹¤í–‰ íŒŒì¼ì´ í—¬ìŠ¤ ì²´í¬ë¥¼ í•œ ë’¤ í†µê³¼ë˜ë©´ nginx.conf íŒŒì¼ì„ ê³ ì¹˜ê³  nginxë¥¼ reload í•˜ê³  íŠ¸ë˜í”½ì„ ì „í™˜í•œë‹¤. ë¬¼ë¡  í•œ ê°€ì§€ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ ì„œë²„ê°€ ê³„ì† ì„œë¹„ìŠ¤ëœë‹¤. ì²˜ìŒ ì‹¤í–‰í•  ë•Œì—ëŠ” 

<CodeBlock>
  -bash: ./deploy.sh: Permission denied
</CodeBlock>

ì´ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆë‹¤. íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì´ ì—†ë‹¤ëŠ” ëœ»ì´ë‹¤.

<CodeBlock>
  chmod +x deploy.sh
</CodeBlock>

ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•˜ê³  ë‹¤ì‹œ ./deploy.sh ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. 

<MDXImage
  src="/posts/blue-green/success.png"
  alt="Successed the blue green deployment"
  style={{ width: "70%" }}
/>
<br />
ë©‹ì§€ê²Œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ì„± ğŸ˜âœŒï¸âœŒï¸
<br />
<br />